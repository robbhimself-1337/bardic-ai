{% extends "character/base_wizard.html" %}

{% block title %}Step 4: Ability Scores{% endblock %}

{% block extra_css %}
<style>
    .step-header { text-align: center; margin-bottom: 30px; }
    .step-header h2 { color: #d4af37; font-size: 2em; margin-bottom: 10px; }
    .method-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        justify-content: center;
    }
    .tab-btn {
        padding: 12px 30px;
        background: transparent;
        border: 2px solid #d4af37;
        color: #d4af37;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-btn.active {
        background: #d4af37;
        color: #2c1810;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .abilities-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .ability-box {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #8b7355;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }
    .ability-name {
        color: #d4af37;
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    .ability-score {
        font-size: 2.5em;
        color: #90ee90;
        margin: 10px 0;
    }
    .ability-modifier {
        font-size: 1.5em;
        color: #f4d03f;
    }
    .ability-input {
        width: 80px;
        padding: 8px;
        font-size: 1.5em;
        text-align: center;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid #d4af37;
        border-radius: 5px;
        color: #90ee90;
    }
    .ability-input option:disabled {
        color: #666;
        background: rgba(0, 0, 0, 0.8);
    }
    .standard-array {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .array-value {
        padding: 15px 25px;
        background: #d4af37;
        color: #2c1810;
        font-size: 1.5em;
        font-weight: bold;
        border-radius: 8px;
        cursor: grab;
    }
    .roll-section {
        text-align: center;
    }
    .roll-btn {
        padding: 15px 40px;
        font-size: 1.3em;
        background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
        border: none;
        border-radius: 10px;
        color: #2c1810;
        font-weight: bold;
        cursor: pointer;
        margin: 20px 0;
    }
    .roll-result {
        font-size: 1.2em;
        color: #90ee90;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="step-header">
    <h2>Determine Ability Scores</h2>
    <p>Choose how to generate your character's six ability scores</p>
</div>

<div class="method-tabs">
    <button class="tab-btn active" onclick="showTab('standard')">Standard Array</button>
    <button class="tab-btn" onclick="showTab('pointbuy')">Point Buy</button>
    <button class="tab-btn" onclick="showTab('roll')">Roll Dice</button>
</div>

<div id="standard" class="tab-content active">
    <p style="text-align: center; color: #c0b090; margin-bottom: 20px;">
        Assign these values to your abilities: <strong>15, 14, 13, 12, 10, 8</strong>
    </p>
    <div class="abilities-grid">
        <div class="ability-box">
            <div class="ability-name">Strength</div>
            <select class="ability-input standard-array-select" id="str" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15" selected>15</option>
                <option value="14">14</option>
                <option value="13">13</option>
                <option value="12">12</option>
                <option value="10">10</option>
                <option value="8">8</option>
            </select>
            <div class="ability-modifier" id="str-mod">+2</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Dexterity</div>
            <select class="ability-input standard-array-select" id="dex" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15">15</option>
                <option value="14" selected>14</option>
                <option value="13">13</option>
                <option value="12">12</option>
                <option value="10">10</option>
                <option value="8">8</option>
            </select>
            <div class="ability-modifier" id="dex-mod">+2</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Constitution</div>
            <select class="ability-input standard-array-select" id="con" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15">15</option>
                <option value="14">14</option>
                <option value="13" selected>13</option>
                <option value="12">12</option>
                <option value="10">10</option>
                <option value="8">8</option>
            </select>
            <div class="ability-modifier" id="con-mod">+1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Intelligence</div>
            <select class="ability-input standard-array-select" id="int" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15">15</option>
                <option value="14">14</option>
                <option value="13">13</option>
                <option value="12" selected>12</option>
                <option value="10">10</option>
                <option value="8">8</option>
            </select>
            <div class="ability-modifier" id="int-mod">+1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Wisdom</div>
            <select class="ability-input standard-array-select" id="wis" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15">15</option>
                <option value="14">14</option>
                <option value="13">13</option>
                <option value="12">12</option>
                <option value="10" selected>10</option>
                <option value="8">8</option>
            </select>
            <div class="ability-modifier" id="wis-mod">+0</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Charisma</div>
            <select class="ability-input standard-array-select" id="cha" onchange="handleStandardArrayChange()">
                <option value="">-</option>
                <option value="15">15</option>
                <option value="14">14</option>
                <option value="13">13</option>
                <option value="12">12</option>
                <option value="10">10</option>
                <option value="8" selected>8</option>
            </select>
            <div class="ability-modifier" id="cha-mod">-1</div>
        </div>
    </div>
</div>

<div id="pointbuy" class="tab-content">
    <p style="text-align: center; color: #c0b090; margin-bottom: 20px;">
        Points Remaining: <span id="pointsLeft" style="color: #d4af37; font-weight: bold;">27</span>
    </p>
    <p style="text-align: center; color: #c0b090; margin-bottom: 20px; font-size: 0.9em;">
        (Costs: 8=0, 9=1, 10=2, 11=3, 12=4, 13=5, 14=7, 15=9)
    </p>
    <div class="abilities-grid">
        <div class="ability-box">
            <div class="ability-name">Strength</div>
            <input type="number" class="ability-input" id="pb-str" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-str-mod">-1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Dexterity</div>
            <input type="number" class="ability-input" id="pb-dex" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-dex-mod">-1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Constitution</div>
            <input type="number" class="ability-input" id="pb-con" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-con-mod">-1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Intelligence</div>
            <input type="number" class="ability-input" id="pb-int" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-int-mod">-1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Wisdom</div>
            <input type="number" class="ability-input" id="pb-wis" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-wis-mod">-1</div>
        </div>
        <div class="ability-box">
            <div class="ability-name">Charisma</div>
            <input type="number" class="ability-input" id="pb-cha" min="8" max="15" value="8" onchange="updatePointBuy()">
            <div class="ability-modifier" id="pb-cha-mod">-1</div>
        </div>
    </div>
</div>

<div id="roll" class="tab-content">
    <div class="roll-section">
        <p style="color: #c0b090; margin-bottom: 20px;">Roll 4d6, drop the lowest die, six times</p>
        <button class="roll-btn" onclick="rollAbilities()">üé≤ Roll All Abilities üé≤</button>
        <div id="rollResults" style="margin-top: 30px;"></div>
    </div>
</div>

<form method="POST" id="abilitiesForm">
    <input type="hidden" name="strength" id="final-str">
    <input type="hidden" name="dexterity" id="final-dex">
    <input type="hidden" name="constitution" id="final-con">
    <input type="hidden" name="intelligence" id="final-int">
    <input type="hidden" name="wisdom" id="final-wis">
    <input type="hidden" name="charisma" id="final-cha">
    <div class="navigation">
        <a href="/character/step2" class="btn btn-secondary">‚Üê Back</a>
        <button type="submit" class="btn btn-primary" id="nextBtn">Next: Background ‚Üí</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    function showTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        event.target.classList.add('active');
        document.getElementById(tabName).classList.add('active');

        // Update validation based on active tab
        if (tabName === 'standard') {
            validateStandardArray();
        } else if (tabName === 'pointbuy') {
            updatePointBuy();
        } else if (tabName === 'roll') {
            // Roll mode - check if abilities have been rolled
            const rollResults = document.getElementById('rollResults');
            const hasRolled = rollResults.innerHTML.includes('abilities-grid');
            document.getElementById('nextBtn').disabled = !hasRolled;
        }
    }

    function handleStandardArrayChange() {
        // Update modifiers for all abilities
        updateStandardArrayModifiers();

        // Update disabled states to prevent duplicates
        updateStandardArrayAvailability();

        // Validate all selections
        validateStandardArray();
    }

    function updateStandardArrayModifiers() {
        ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ability => {
            const score = parseInt(document.getElementById(ability).value) || 10;
            const modifier = Math.floor((score - 10) / 2);
            document.getElementById(ability + '-mod').textContent = modifier >= 0 ? '+' + modifier : modifier;
            document.getElementById('final-' + ability).value = score;
        });
    }

    function updateStandardArrayAvailability() {
        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        const standardArrayValues = ['15', '14', '13', '12', '10', '8'];

        // Collect currently selected values
        const selectedValues = {};
        abilities.forEach(ability => {
            const select = document.getElementById(ability);
            const value = select.value;
            if (value) {
                selectedValues[ability] = value;
            }
        });

        // For each dropdown, disable options that are selected elsewhere
        abilities.forEach(currentAbility => {
            const currentSelect = document.getElementById(currentAbility);
            const currentValue = currentSelect.value;

            // Get all options in this dropdown
            const options = currentSelect.querySelectorAll('option');

            options.forEach(option => {
                const optionValue = option.value;

                // Skip the empty option
                if (optionValue === '') {
                    return;
                }

                // Check if this value is selected in another dropdown
                const isSelectedElsewhere = Object.entries(selectedValues).some(
                    ([ability, value]) => ability !== currentAbility && value === optionValue
                );

                // Disable if selected elsewhere, enable if not
                option.disabled = isSelectedElsewhere;
            });
        });
    }

    function validateStandardArray() {
        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        const selectedValues = abilities.map(ability => document.getElementById(ability).value);

        // Check if all values are selected (no empty values)
        const allSelected = selectedValues.every(value => value !== '');

        // Check for duplicates
        const hasDuplicates = selectedValues.some((value, index) =>
            value !== '' && selectedValues.indexOf(value) !== index
        );

        // Enable next button only if all selected and no duplicates
        const nextBtn = document.getElementById('nextBtn');
        nextBtn.disabled = !allSelected || hasDuplicates;
    }

    function updateModifiers() {
        ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(ability => {
            const score = parseInt(document.getElementById(ability).value) || 10;
            const modifier = Math.floor((score - 10) / 2);
            document.getElementById(ability + '-mod').textContent = modifier >= 0 ? '+' + modifier : modifier;
            document.getElementById('final-' + ability).value = score;
        });
    }

    function updatePointBuy() {
        // Point cost lookup table
        const pointCosts = {
            8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
        };

        const abilities = ['str', 'dex', 'con', 'int', 'wis', 'cha'];
        let totalPointsSpent = 0;

        // Calculate total points spent and update modifiers
        abilities.forEach(ability => {
            const input = document.getElementById('pb-' + ability);
            let score = parseInt(input.value) || 8;

            // Enforce min/max bounds
            if (score < 8) {
                score = 8;
                input.value = 8;
            }
            if (score > 15) {
                score = 15;
                input.value = 15;
            }

            // Add to total points spent
            totalPointsSpent += pointCosts[score] || 0;

            // Update modifier display
            const modifier = Math.floor((score - 10) / 2);
            document.getElementById('pb-' + ability + '-mod').textContent =
                modifier >= 0 ? '+' + modifier : modifier;

            // Update hidden form field
            document.getElementById('final-' + ability).value = score;
        });

        // Update points remaining display
        const pointsRemaining = 27 - totalPointsSpent;
        const pointsLeftElement = document.getElementById('pointsLeft');
        pointsLeftElement.textContent = pointsRemaining;

        // Color code the points remaining
        if (pointsRemaining < 0) {
            pointsLeftElement.style.color = '#ff6b6b'; // Red - over budget
        } else if (pointsRemaining === 0) {
            pointsLeftElement.style.color = '#90ee90'; // Green - perfect
        } else {
            pointsLeftElement.style.color = '#d4af37'; // Gold - points left
        }

        // Enable next button only if exactly 0 points remaining
        const nextBtn = document.getElementById('nextBtn');
        nextBtn.disabled = (pointsRemaining !== 0);
    }

    function rollAbilities() {
        const results = [];
        for (let i = 0; i < 6; i++) {
            const rolls = [
                Math.floor(Math.random() * 6) + 1,
                Math.floor(Math.random() * 6) + 1,
                Math.floor(Math.random() * 6) + 1,
                Math.floor(Math.random() * 6) + 1
            ].sort((a, b) => b - a);
            const total = rolls[0] + rolls[1] + rolls[2];
            results.push(total);
        }

        // Auto-assign to abilities in order
        const abilities = [
            { id: 'str', name: 'Strength' },
            { id: 'dex', name: 'Dexterity' },
            { id: 'con', name: 'Constitution' },
            { id: 'int', name: 'Intelligence' },
            { id: 'wis', name: 'Wisdom' },
            { id: 'cha', name: 'Charisma' }
        ];

        // Build the ability grid HTML
        let gridHTML = '<div class="abilities-grid">';

        abilities.forEach((ability, index) => {
            const score = results[index];
            const modifier = Math.floor((score - 10) / 2);
            const modifierText = modifier >= 0 ? '+' + modifier : modifier;
            const modifierColor = modifier > 0 ? '#90ee90' : (modifier < 0 ? '#ff6b6b' : '#f0e6d2');

            // Update hidden form field
            document.getElementById('final-' + ability.id).value = score;

            gridHTML += `
                <div class="ability-box">
                    <div class="ability-name">${ability.name}</div>
                    <div class="ability-score">${score}</div>
                    <div class="ability-modifier" style="color: ${modifierColor}">${modifierText}</div>
                </div>
            `;
        });

        gridHTML += '</div>';
        gridHTML += '<p style="text-align: center; color: #c0b090; margin-top: 20px; font-size: 0.9em;">Don\'t like these rolls? Click the button above to reroll!</p>';

        document.getElementById('rollResults').innerHTML = gridHTML;

        // Enable next button
        document.getElementById('nextBtn').disabled = false;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize standard array with defaults
        updateStandardArrayModifiers();
        updateStandardArrayAvailability();
        validateStandardArray();
    });
</script>
{% endblock %}
